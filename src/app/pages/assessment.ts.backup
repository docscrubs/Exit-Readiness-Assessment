import { Component, OnInit, computed, inject, signal } from '@angular/core';
import { Router, RouterLink } from '@angular/router';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { AssessmentLevel, AssessmentSpec, Responses } from '../models/assessment';
import { AssessmentService } from '../services/assessment.service';
import { RadarComponent } from '../components/radar';
import { RecommendationService } from '../services/recommendation.service';

@Component({
  selector: 'app-assessment-page',
  standalone: true,
  imports: [CommonModule, RouterLink, RadarComponent, FormsModule],
  template: `
    <section class="container mx-auto px-6 py-10 lg:py-12">
      <div class="mb-8 flex items-start justify-between gap-6">
        <div>
          <h1 class="text-3xl font-bold text-slate-900">SME Exit Readiness Assessment</h1>
          <div class="mt-2 text-slate-600 max-w-prose" >
            Assess your organization's readiness for exit across 6 critical domains. Each domain is rated 0–4: Incomplete, Initial, Defined, Managed, Optimized. Click on your level to see what it means—transparency over perfection is what buyers value.
            <br />
            This assessment takes 30-60 minutes and provides instant feedback on gaps, critical thresholds, and estimated timeline to transaction readiness.
           <br />
            <span class="font-bold">If you don't understand a question or the area doesn't apply to your business, choose 0. You'll receive a code on your report to save and restore your answers anytime.</span>

            <div class="mt-4">
              <div class="flex flex-col sm:flex-row sm:items-center">
                <input [(ngModel)]="importCode" placeholder="Enter code to restore saved answers" class="input flex-1 sm:max-w-md rounded-lg h-10 px-3" />
                <div class="flex gap-2 mt-3 sm:mt-0 sm:ml-3">
                  <button class="btn btn-primary h-10" (click)="restoreFromCode(importCode)">Load code</button>
                  <button class="btn btn-outline h-10" (click)="clearImportCode()">Clear</button>
                </div>
              </div>

              <div *ngIf="restoreToast()" class="mt-3">
                <div class="inline-flex items-center gap-3 rounded-md bg-slate-50 border px-3 py-2" [ngStyle]="{ 'border-color': primaryColor }">
                  <svg class="h-5 w-5 text-slate-700" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="9" stroke="currentColor" stroke-opacity="0.12"/><path d="M7 10l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  <div class="text-sm font-medium text-slate-800">{{ restoreToast()?.text }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <a routerLink="/" class="btn btn-secondary">Back to home</a>
      </div>

      <ng-container *ngIf="spec() as s; else loading">

        <div class="mt-8 grid lg:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div *ngFor="let dim of s.dimensions" class="rounded-xl border border-slate-200 bg-white p-5">
              <div class="mb-3 flex items-center justify-between">
                <h2 class="font-semibold text-slate-900">{{ dim.name }}</h2>
                <span class="text-xs text-slate-500">{{ dim.questions.length }} items</span>
              </div>
              <ol class="space-y-4">
                <li *ngFor="let q of dim.questions" class="rounded-lg border border-slate-100 bg-slate-50 p-4">
                  <div class="text-sm text-slate-800">{{ q.text }}</div>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <button
                      *ngFor="let v of scaleValues()"
                      type="button"
                      (click)="setResponse(q.id, v)"
                      [class.btn-selected]="responses()[q.id] === v"
                      class="btn btn-choice"
                    >
                      {{ v }}
                    </button>
                  </div>
                  <div class="mt-2 text-xs text-slate-500" *ngIf="responses()[q.id] !== undefined">Selected: {{ labelFor(responses()[q.id]) }}</div>
                  <div class="mt-3 text-sm text-slate-600" *ngIf="responses()[q.id] !== undefined">
                    <strong>This means:</strong>&nbsp;{{ explanationFor(q.id, responses()[q.id]) }}
                  </div>
                </li>
              </ol>
            </div>
          </div>
          <div class="space-y-6">
            <div class="rounded-xl border border-slate-200 bg-white p-6">
              <h3 class="font-semibold text-slate-900">Your results</h3>
              <p class="mt-1 text-sm text-slate-600">Scores update as you answer.</p>

              <div class="mt-4">
                <app-radar [labels]="dimensionLabels()" [values]="dimensionAverages()" [max]="s.scale.max" [strokeColor]="primaryColor" [fillColor]="accentColor"></app-radar>
              </div>

              <div class="mt-4 space-y-3">
                <div *ngFor="let dim of s.dimensions" class="">
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-slate-700">{{ dim.name }}</span>
                    <span class="font-medium text-slate-900">{{ dimScore(dim.id) | number:'1.0-2' }} / {{ s.scale.max }}</span>
                  </div>
                  <div class="mt-1 h-2 w-full rounded-full bg-slate-100">
                    <div class="h-2 rounded-full bg-secondary" [style.width.%]="(dimScore(dim.id) / s.scale.max) * 100"></div>
                  </div>
                </div>
              </div>

              <div class="mt-6 rounded-lg border border-slate-200 p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs uppercase tracking-wide text-slate-500">Overall</div>
                    <div class="text-2xl font-bold text-slate-900">{{ overallPercent() | number:'1.0-1' }}%</div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs uppercase tracking-wide text-slate-500">Level</div>
                    <div class="font-semibold" [ngStyle]="{ color: levelColor(overallLevel()) }">{{ overallLevel()?.name || '—' }}</div>
                  </div>
                </div>
                <div class="mt-4 h-2 w-full rounded-full bg-slate-100">
                  <div class="h-2 rounded-full" [ngStyle]="{ width: (overallScore() / s.scale.max) * 100 + '%', background: levelGradient() }"></div>
                </div>
              </div>

              <div class="mt-4 flex gap-3">
                <button class="btn btn-primary flex-1" (click)="exportCSV()">Export CSV</button>
                <button class="btn btn-secondary" (click)="clearResponses()">Clear</button>
              </div>

              <button class="btn btn-primary w-full mt-4" [disabled]="answeredCount() < totalCount()" (click)="finalize()">Finalise and view recommendations</button>
              <div class="mt-2 text-xs text-slate-500" *ngIf="answeredCount() < totalCount()">Answer all items to unlock recommendations.</div>
            </div>

            <div *ngIf="showTips()" class="rounded-xl border border-slate-200 bg-white p-6">
              <h3 class="font-semibold text-slate-900">Recommendations</h3>
              <ul class="mt-2 list-disc pl-5 text-slate-700 space-y-2">
                <li *ngFor="let tip of recommendations()">{{ tip }}</li>
              </ul>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #loading>
        <div class="py-24 text-center text-slate-600">Loading assessment…</div>
      </ng-template>
    </section>
  `,
  styles: [``]
})
export class AssessmentPageComponent implements OnInit {
  private svc = inject(AssessmentService);
  private router = inject(Router);
  private recSvc = inject(RecommendationService);

  spec = signal<AssessmentSpec | null>(null);
  responses = signal<Responses>({});
  showTips = signal(false);

  primaryColor = '#3f1954';
  accentColor = '#ed0776';

  importCode = '';
  restoreToast = signal<{ text: string } | null>(null);

  // encoding constants (primes)
  private readonly CODE_MUL = 15485863n;
  private readonly CODE_OFF = 32452843n;

  clearImportCode() { this.importCode = ''; }

  generateCode(): string {
    const s = this.spec();
    if (!s) return '';
    // gather answers in spec order
    const answers: number[] = [];
    for (const d of s.dimensions) for (const q of d.questions) answers.push(this.responses()[q.id] ?? 0);
    // pack in base-5
    let acc = 0n;
    for (const v of answers) { acc = acc * 5n + BigInt(v); }
    // obfuscate
    const obf = acc * this.CODE_MUL + this.CODE_OFF;
    const checksum = Number(obf % 36n);
    const main = this.bigIntToBase36(obf);
    const code = (main + checksum.toString(36)).toUpperCase();
    return code;
  }

  // convert BigInt to base36 string
  private bigIntToBase36(n: bigint) {
    if (n === 0n) return '0';
    const chars = [];
    let v = n < 0n ? -n : n;
    while (v > 0n) {
      const d = Number(v % 36n);
      chars.push(d.toString(36));
      v = v / 36n;
    }
    return chars.reverse().join('');
  }

  private base36ToBigInt(str: string) {
    let r = 0n;
    for (const ch of str) {
      const d = BigInt(parseInt(ch, 36));
      r = r * 36n + d;
    }
    return r;
  }

  restoreFromCode(code: string) {
    if (!code) return;
    try {
      code = code.trim().toUpperCase();
      const chkChar = code.slice(-1);
      const main = code.slice(0, -1);
      const obf = this.base36ToBigInt(main);
      const chk = Number(obf % 36n);
      if (chk !== parseInt(chkChar, 36)) { this.showRestoreToast('Invalid code'); return; }
      if ((obf - this.CODE_OFF) % this.CODE_MUL !== 0n) { this.showRestoreToast('Invalid code'); return; }
      let acc = (obf - this.CODE_OFF) / this.CODE_MUL;
      const s = this.spec();
      if (!s) { this.showRestoreToast('Spec not loaded'); return; }
      const total = s.dimensions.reduce((a, d) => a + d.questions.length, 0);
      const vals: number[] = [];
      for (let i = 0; i < total; i++) {
        const v = Number(acc % 5n);
        vals.push(v);
        acc = acc / 5n;
      }
      // vals are least-significant first -> reverse
      vals.reverse();
      // map back to responses
      const newResp: Responses = { ...this.responses() };
      let idx = 0;
      for (const d of s.dimensions) {
        for (const q of d.questions) {
          newResp[q.id] = vals[idx++] ?? 0;
        }
      }
      this.responses.set(newResp);
      this.saveResponses();
      this.showRestoreToast('Responses restored');
    } catch (e) { this.showRestoreToast('Invalid code'); }
  }

  ngOnInit(): void {
    this.svc.load().subscribe((spec) => {
      this.spec.set(spec);
      // Initialize all responses to 0 so every question is selected as 0 by default.
      this.initializeResponsesToZero();
    });
  }

  showRestoreToast(text: string) {
    this.restoreToast.set({ text });
    setTimeout(() => this.restoreToast.set(null), 3000);
  }

  initializeResponsesToZero() {
    const s = this.spec();
    if (!s) return;
    const initial: Responses = {};
    for (const d of s.dimensions) {
      for (const q of d.questions) {
        initial[q.id] = 0;
      }
    }
    this.responses.set(initial);
  }

  storageKey() { return `exit-readiness:${this.spec()?.title ?? 'default'}`; }

  // Restore saved responses only when the user requests it
  restoreResponses() {
    try {
      const raw = localStorage.getItem(this.storageKey());
      if (raw) this.responses.set(JSON.parse(raw));
    } catch (e) { /* ignore */ }
  }

  saveResponses() {
    try {
      localStorage.setItem(this.storageKey(), JSON.stringify(this.responses()));
    } catch (e) { /* ignore */ }
  }

  clearResponses() {
    // Reset all responses back to 0 for every question
    this.initializeResponsesToZero();
    try { localStorage.removeItem(this.storageKey()); } catch (e) {}
  }

  hasSavedResponses() {
    try { return !!localStorage.getItem(this.storageKey()); } catch (e) { return false; }
  }

  scaleValues() {
    const s = this.spec();
    if (!s) return [] as number[];
    return Array.from({ length: s.scale.max - s.scale.min + 1 }, (_, i) => s.scale.min + i);
  }

  labelFor(value: number) {
    const s = this.spec();
    if (!s) return String(value);
    const idx = value - s.scale.min;
    return s.scale.labels[idx] ?? String(value);
  }

  setResponse(qid: string, value: number) {
    this.responses.update((r) => ({ ...r, [qid]: value }));
    this.saveResponses();
  }

  totalCount = computed(() => this.spec()?.dimensions.reduce((acc, d) => acc + d.questions.length, 0) ?? 0);
  answeredCount = computed(() => Object.keys(this.responses()).length);
  progressPct = computed(() => (this.totalCount() ? (this.answeredCount() / this.totalCount()) * 100 : 0));

  dimScore = (dimId: string) => {
    const s = this.spec();
    if (!s) return 0;
    const dim = s.dimensions.find((d) => d.id === dimId);
    if (!dim) return 0;
    const values = dim.questions.map((q) => this.responses()[q.id]).filter((v): v is number => typeof v === 'number');
    if (!values.length) return 0;
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    return avg;
  };

  dimensionAverages() {
    const s = this.spec();
    if (!s) return [] as number[];
    return s.dimensions.map(d => this.dimScore(d.id));
  }

  dimensionLabels() {
    const s = this.spec();
    if (!s) return [] as string[];
    return s.dimensions.map(d => d.name);
  }

  // Explanations for each question id, values 0..4
  private explanations: Record<string, string[]> = {
    // Financial Domain (f1-f6)
    f1: ['No bookkeeping; records incomplete.', 'Basic records; annual filing only.', 'Monthly management accounts; no audit.', '3+ years audited accounts; clean records.', 'Vendor FDD ready; locked-box capable.'],
    f2: ['No management accounts.', 'Irregular P&L; no balance sheet.', 'Monthly P&L and balance sheet.', 'Comprehensive MI; board-reviewed.', 'Real-time dashboards; investor-grade.'],
    f3: ['EBITDA unknown.', 'Basic profit known; no normalization.', 'EBITDA calculated; adjustments incomplete.', 'Normalized EBITDA; 3-year trend.', 'Quality of earnings analysis complete.'],
    f4: ['No revenue policy; ad hoc.', 'Inconsistent recognition; no policy.', 'Policy documented; mostly consistent.', 'Compliant (IFRS 15); audited.', 'Fully documented; audit-ready.'],
    f5: ['Working capital unmanaged.', 'Basic awareness; not tracked.', 'Debtors/creditors tracked.', 'Actively managed; optimized.', 'Automated; cash conversion minimized.'],
    f6: ['Tax returns late/missing.', 'Current but poor quality.', 'Compliance current; some planning.', 'All current; clearances obtained.', 'Full tax DD; all clearances in hand.'],
    
    // Legal & Corporate (l1-l6)
    l1: ['Corporate structure unclear.', 'Filings current; registers incomplete.', 'Structure documented; mostly current.', 'Clean cap table; all updated.', 'Full legal review; DD-ready.'],
    l2: ['No board minutes or resolutions.', 'Some minutes; incomplete records.', 'Minutes maintained; some gaps.', 'Complete statutory books.', 'Company secretarial audit done.'],
    l3: ['Contracts not identified.', 'Key contracts known; not catalogued.', 'Catalogued; assignability uncertain.', 'All documented; mostly assignable.', 'Contract DD pack prepared.'],
    l4: ['IP ownership unclear.', 'Some IP identified; not transferred.', 'Key IP documented; assignments obtained.', 'All IP owned; registrations current.', 'Full IP audit; DD pack ready.'],
    l5: ['Assets untracked; leases missing.', 'Assets identified; documentation incomplete.', 'Register maintained; documented.', 'Complete register; leases assignable.', 'Full asset DD pack.'],
    l6: ['Litigation undisclosed/unknown.', 'Disputes known; not quantified.', 'All disclosed; provisions made.', 'All resolved or quantified.', 'Full history reviewed; all closed.'],
    
    // Commercial (c1-c6)
    c1: ['Customer concentration >50%.', 'Top customer >30%; risk identified.', 'Top customer <30%; diversifying.', 'Diversified; largest <25%.', 'Highly diversified; no customer >20%.'],
    c2: ['All project-based; no visibility.', 'Some repeat; no contracts.', 'Contracted revenue >20%.', 'Recurring >40%; multi-year contracts.', 'Recurring >60%; long-term contracts.'],
    c3: ['Churn unknown.', 'Churn estimated; not measured.', 'Retention tracked; churn quantified.', 'Low churn (<15%); NPS tracked.', 'Best-in-class (<5%); NPS >50.'],
    c4: ['No pipeline tracking.', 'Pipeline informal; no CRM.', 'CRM in use; pipeline managed.', 'Structured pipeline; forecasting accurate.', 'Data-driven sales; pipeline >3x target.'],
    c5: ['Market position unclear.', 'Aware of competitors; not positioned.', 'Position understood; advantages documented.', 'Defensible position; USP clear.', 'Market leadership evidenced.'],
    c6: ['Satisfaction unknown.', 'Informal feedback only.', 'Surveys conducted; NPS tracked.', 'Regular feedback; strong relationships.', 'Best-in-class NPS; advocacy programs.'],
    
    // Operational (o1-o6)
    o1: ['Processes undocumented.', 'Understood but not written.', 'SOPs exist; incomplete.', 'Comprehensive SOPs; followed.', 'Process excellence; ISO certified.'],
    o2: ['Founder essential for all.', 'Founder heavily involved.', 'Some delegation; still dependent.', 'Minimal founder involvement.', 'Fully independent; operates through deal.'],
    o3: ['No backups; systems undocumented.', 'Basic backups; DR untested.', 'Regular backups; DR documented.', 'Resilient IT; DR tested quarterly.', 'Best-practice resilience; geo-redundant.'],
    o4: ['Single suppliers; high risk.', 'Key suppliers; no contingency.', 'Alternatives identified.', 'Actively managed; risks mitigated.', 'Optimized; strategic partnerships.'],
    o5: ['No quality controls.', 'Informal checks; high variability.', 'Standards defined; some controls.', 'Formal QMS; metrics tracked.', 'TQM culture; ISO 9001 certified.'],
    o6: ['Scalability unknown.', 'Some growth; not proven.', 'Growth demonstrated.', 'Scalable; 2-3x headroom.', 'Highly scalable; proven track record.'],
    
    // People & Organisation (p1-p6)
    p1: ['No management below founder.', 'One deputy; not empowered.', 'Org chart; limited depth.', 'Management team in place.', 'Deep bench; transaction-ready.'],
    p2: ['Entirely founder-dependent.', 'Risk identified; not addressed.', 'Some documentation; planning started.', 'Risk mitigated; succession plans.', 'Zero dependency; strong pipeline.'],
    p3: ['Contracts missing/non-compliant.', 'Contracts exist; outdated.', 'Current for most; descriptions exist.', 'All current and compliant.', 'Audit-ready; legal-reviewed.'],
    p4: ['No HR policies.', 'Basic policies; not applied.', 'Handbook exists; mostly compliant.', 'Comprehensive; consistently applied.', 'Best-practice; annually reviewed.'],
    p5: ['No retention mechanisms.', 'Informal discussions only.', 'Bonuses identified; some arrangements.', 'Formal packages for key staff.', 'Comprehensive stay bonuses; >95% assured.'],
    p6: ['Flat; no delegation.', 'Basic org chart; roles overlap.', 'Structure defined; clear lines.', 'Well-designed; supports growth.', 'Optimal design; investor-grade.'],
    
    // ESG & Risk (e1-e6)
    e1: ['Environmental impact unknown.', 'Awareness but no assessment.', 'Impact assessed; some measurement.', 'Measured and managed; targets set.', 'Carbon footprint measured; net zero roadmap.'],
    e2: ['H&S compliance unknown.', 'Basic awareness; reactive.', 'Policies documented; training provided.', 'Full compliance; strong culture.', 'Best-practice; ISO 45001; zero incidents.'],
    e3: ['GDPR compliance absent.', 'Awareness; limited implementation.', 'Policies documented; basic compliance.', 'Full compliance; DPO appointed.', 'Privacy by design; external audit.'],
    e4: ['No cyber controls.', 'Basic antivirus; no testing.', 'Policies in place; some testing.', 'Cyber Essentials certified; tested.', 'ISO 27001; SOC monitoring; zero trust.'],
    e5: ['No risk register.', 'Risks informal; no assessment.', '

  explanationFor(qid: string, value: number) {
    const arr = this.explanations[qid];
    if (!arr) return '';
    return arr[value] ?? '';
  }

  overallScore = computed(() => {
    const s = this.spec();
    if (!s) return 0;
    const weights = s.dimensions.map((d) => d.weight ?? 1);
    const totalW = weights.reduce((a, b) => a + b, 0);
    const sum = s.dimensions.reduce((acc, d) => acc + this.dimScore(d.id) * (d.weight ?? 1), 0);
    return totalW ? sum / totalW : 0;
  });

  // Overall as percentage (0 - 100)
  overallPercent = computed(() => {
    const s = this.spec();
    if (!s) return 0;
    const max = s.scale.max;
    const score = this.overallScore();
    return max ? (score / max) * 100 : 0;
  });

  overallLevel = computed<AssessmentLevel | null>(() => {
    const s = this.spec();
    if (!s) return null;
    const score = this.overallScore();
    // find matching level
    return s.levels.find((lvl) => score >= lvl.min && score < lvl.max) ?? s.levels[s.levels.length - 1] ?? null;
  });

  levelColor(lvl: AssessmentLevel | null) {
    return lvl?.color ?? '#334155';
  }

  levelGradient() {
    const s = this.spec();
    if (!s) return `linear-gradient(90deg, #e11d48, #f59e0b, ${this.primaryColor}, ${this.accentColor})`;
    const stops = s.levels.map((l) => l.color).join(', ');
    return `linear-gradient(90deg, ${stops})`;
  }

  finalize() {
    // allow report viewing once
    try { localStorage.setItem('assessment:canViewReport', '1'); } catch (e) {}
    this.showTips.set(true);
    this.router.navigate(['/report']);
  }

  recommendations = computed(() => {
    const s = this.spec();
    if (!s) return [] as string[];
    return this.recSvc.computeRecommendations(s, this.responses());
  });

  exportCSV() {
    const s = this.spec();
    if (!s) return;
    const rows: string[] = [];
    rows.push(['domain','questionId','questionText','score'].join(','));
    for (const d of s.dimensions) {
      for (const q of d.questions) {
        const score = this.responses()[q.id];
        rows.push([`"${d.name}"`, q.id, `"${q.text.replace(/"/g,'""')}"`, typeof score === 'number' ? score : ''].join(','));
      }
    }
    const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${s.title.replace(/\s+/g,'_')}_responses.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }
}
